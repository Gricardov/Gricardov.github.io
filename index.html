<!DOCTYPE html>

<head>

  <meta charset="UTF-8">
  <script lang="javascript" src="js/jquery-3.3.1.js"></script>
  <link rel="stylesheet" href="css/tabla.css">
  <script lang="javascript" src="js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="css/bootstrap.min.css" type="text/css">
  <link rel="stylesheet" href="css/style.css" type="text/css">

  <link rel="stylesheet" href="css/jquery.page.css" type="text/css" />
  <link rel="stylesheet" href="css/all.css" />

  <script lang="javascript" src="js/jquery.page.min.js"></script>
  <script lang="javascript" src="js/js-xlsx/dist/shim.min.js"></script>
  <script lang="javascript" src="js/js-xlsx/dist/xlsx.full.min.js"></script>

  <script lang="javascript" src="js/FileSaver/dist/FileSaver.min.js"></script>

  <!--exceljs-->
  <script type="text/javascript" src="js/exceljs.min.js"></script>

</head>

<body>
  <div class="container">
    <div class='panel panel-primary dialog-panel container'>
      <div class='panel-heading row' id="encabezado">
        <div class="col-md-offset-5 col-md-7">
          <h4 class="float-left">Generar factura</h4>
        </div>
      </div>

      <div id="contenedor">

        <div class="container">

          <div class="page" data-jquery-page-name="1">
            <div class="row">
              <div class="col-md-offset-2 col-md-8">
                <h3 class="text-muted">Datos generales</h3>
              </div>
            </div>
            <div class='panel-body row'>

              <div class='form-horizontal'>
                <div class='form-group'>
                  <label class='control-label col-md-2 col-md-offset-2' for='txtRazonSocial'>Razón social</label>
                  <div class='col-md-6'>
                    <input class='form-control' id='txtRazonSocial' placeholder='Ingresar razón social'
                      value="Mi razón social" type="text">
                  </div>
                </div>

                <div class='form-group'>
                  <label class='control-label col-md-2 col-md-offset-2' for='txtRuc'>RUC</label>
                  <div class='col-md-6'>
                    <input class='form-control' id='txtRuc' placeholder='Ingresar RUC' value="123456789" type="number">
                  </div>
                </div>

                <div class='form-group'>
                  <label class='control-label col-md-2 col-md-offset-2' for='txtDireccion'>Dirección</label>
                  <div class='col-md-6'>
                    <input class='form-control' id='txtDireccion' placeholder='Ingresar dirección' value="Mi dirección"
                      type="text">
                  </div>
                </div>

                <div class='form-group'>
                  <label class='control-label col-md-2 col-md-offset-2' for='txtTelefono'>Teléfono</label>
                  <div class='col-md-6'>
                    <input class='form-control' id='txtTelefono' placeholder='Ingresar teléfono' value="987654321"
                      type="number">
                  </div>
                </div>

                <div class='form-group'>
                  <label class='control-label col-md-2 col-md-offset-2' for='txtConsiderarIGV'>IGV cálculo</label>
                  <div class='col-md-2'>
                    <input class='form-control' id='txtConsiderarIGV' type="number">
                  </div>
                  <label class='control-label col-md-1' for='txtConsiderarIGV'>%</label>
                </div>

                <div class='form-group'>
                  <div id="mensajeForm1" class="col-md-offset-4 col-md-6"></div>
                </div>

                <div class='form-group'>
                  <div class='col-md-offset-4 col-md-6'>
                    <button id="btnMostrarReg2" class='btn btn-primary' style="width:100%" data-page-name="2"
                      data-page-trans="slide-in-from-right">Siguiente</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="page" data-jquery-page-name="2">
            <div class="row">
              <div class="col-md-offset-2 col-md-8">
                <h3 class="text-muted">Registro de productos</h3>
              </div>
            </div>
            <div class='panel-body'>

              <div class='form-horizontal'>
                <div class='form-group'>
                  <label class='control-label col-md-2 col-md-offset-2' for='txtDescripcion'>Descripcion
                    producto</label>
                  <div class='col-md-6'>
                    <input class='form-control' id='txtDescripcion' placeholder='Ingresar descripción' type="text">
                  </div>
                </div>

                <div class='form-group'>
                  <label class='control-label col-md-2 col-md-offset-2' for='cboMarca'>Marca</label>
                  <div class='col-md-6'>
                    <select class='form-control' id='cboMarca'>
                      <option>Marca 1</option>
                      <option>Marca 2</option>
                      <option>Marca 3</option>
                      <option>Marca 4</option>
                      <option>Marca 5</option>
                    </select>
                  </div>
                </div>

                <div class='form-group'>
                  <label class='control-label col-md-2 col-md-offset-2' for='cboUnidad'>Unidad</label>
                  <div class='col-md-6'>
                    <select class='form-control' id='cboUnidad'>
                      <option>UNIDAD</option>
                      <option>GALÓN</option>
                      <option>CAJA</option>
                      <option>DOCENA</option>
                      <option>OTRO</option>
                    </select>
                  </div>
                </div>

                <div class='form-group'>
                  <label class='control-label col-md-2 col-md-offset-2' for='txtCantidad'>Cantidad</label>
                  <div class='col-md-6'>
                    <input class='form-control' id='txtCantidad' placeholder='Ingresar cantidad' type="number">
                  </div>
                </div>

                <div class='form-group'>
                  <label class='control-label col-md-2 col-md-offset-2' for='txtPrecio'>Precio unidad</label>
                  <div class='col-md-6'>
                    <input class='form-control' id='txtPrecio' placeholder='Ingresar precio' type="number">
                  </div>
                </div>



                <div class='form-group'>
                  <label class='control-label col-md-2 col-md-offset-2' for='txtPrecioConIGV'>Total con IGV</label>
                  <div class='col-md-6'>
                    <input class='form-control' id='txtPrecioConIGV' type="number" disabled>
                  </div>
                </div>

                <div class='form-group'>
                  <label class='control-label col-md-2 col-md-offset-2' for='txtIGVCalculado'>IGV calculado</label>
                  <div class='col-md-2'>
                    <input class='form-control' id='txtIGVCalculado' type="number" disabled>
                  </div>
                  <label class='control-label col-md-2' for='txtIGV'>Porcentaje IGV</label>
                  <div class='col-md-2'>
                    <input class='form-control' id='txtIGV' type="number" disabled>
                  </div>

                </div>

                <div class='form-group'>
                  <label class='control-label col-md-2 col-md-offset-2' for='txtPrecioSinIGV'>Total sin IGV</label>
                  <div class='col-md-6'>
                    <input class='form-control' id='txtPrecioSinIGV' type="number" disabled>
                  </div>

                </div>

                <div class='form-group'>
                  <div id="mensajeForm2" class="col-md-offset-4 col-md-6"></div>
                </div>

                <div class='form-group'>

                  <div class='col-md-offset-4 col-md-2'>
                    <button id="btnAgregar" class='btn btn-success' style="width:100%">
                      <i class="fa fa-plus"></i> Agregar a la tabla</button>
                  </div>
                  <div class='col-md-2'>
                    <button id="btnActualizar" class='btn btn-info' style="width:100%" disabled>
                      <i class="fa fa-check"></i> Actualizar</button>
                  </div>
                  <div class='col-md-2'>
                    <button id="btnCancelar" class='btn btn-danger' style="width:100%" disabled>
                      <i class="fa fa-times"></i> Cancelar</button>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-12">
                    <h3 class="text-muted">Productos</h3>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-12">

                    <div class="contenedor-tabla">

                      <div class="tabla" id="tabla">

                        <div class="fila-tabla encabezado-tabla blue">
                          <div class="celda-tabla">
                            Item
                          </div>
                          <div class="celda-tabla">
                            Descripción
                          </div>
                          <div class="celda-tabla">
                            Marca/Procedencia
                          </div>
                          <div class="celda-tabla">
                            Unidad
                          </div>
                          <div class="celda-tabla">
                            Cantidad
                          </div>
                          <div class="celda-tabla">
                            Precio unidad
                          </div>
                          <div class="celda-tabla">
                            Total con IGV
                          </div>
                          <div class="celda-tabla">
                            IGV calculado
                          </div>
                          <div class="celda-tabla">
                            Total sin IGV
                          </div>
                          <div class="celda-tabla">

                          </div>
                          <div class="celda-tabla">

                          </div>
                        </div>

                      </div>

                    </div>
                  </div>





                </div>

                <div class="row">
                  <div class="col-md-offset-9 col-md-1">
                    <h4 class="text-muted">Total</h4>
                  </div>
                  <div class="col-md-2">
                    <input class='form-control' id='txtTotalTodo' type="number" disabled>
                  </div>
                </div>

                <div class="row" style="margin-top: 20px;">

                  <div class="col-12">
                    <ul class="nav nav-tabs row">
                      <li class="col-md-4 active"><a data-toggle="tab" href="#menu1">Glassgow</a></li>
                      <li class="col-md-4"><a data-toggle="tab" href="#menu2">Lineas hospitalarias</a></li>
                      <li class="col-md-4"><a data-toggle="tab" href="#menu3">Negociaciones Advance</a></li>
                    </ul>

                    <div class="tab-content">

                      <div id="menu1" class="tab-pane fade in active">
                        <div class="container">
                          <h3>Glassgow</h3>
                          <p>Presione para generar excel</p>
                          <button id="btnExportarGlassgow" class='btn btn-primary' style="width:100%">
                            <i class="fa fa-th"></i> Generar excel</button>
                        </div>
                      </div>
                      <div id="menu2" class="tab-pane fade">
                        <div class="container">

                          <h3>Lineas hospitalarias</h3>
                          <p>Presione para generar excel</p>
                          <button id="btnExportarLH" class='btn btn-warning' style="width:100%">
                            <i class="fa fa-th"></i> Generar excel</button>
                        </div>

                      </div>
                      <div id="menu3" class="tab-pane fade">
                        <div class="container">

                          <h3>Negociaciones Advance</h3>
                          <p>Presione para generar excel</p>
                          <button id="btnExportarNA" class='btn btn-success' style="width:100%">
                            <i class="fa fa-th"></i> Generar excel</button>
                        </div>
                      </div>

                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>


        </div>



      </div>


    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="modalOpcion" role="dialog">
    <div class="modal-dialog">

      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Confirmación</h4>
        </div>
        <div class="modal-body" id="cuerpoModalOpcion">

        </div>
        <div class="modal-footer">
          <button type="button" id="btnSi" class="btn btn-danger" data-dismiss="modal">Sí</button>
          <button type="button" class="btn btn-primary" id="btnNo" data-dismiss="modal">No</button>
        </div>
      </div>

    </div>
  </div>

  <div id="excel" style="display: none;">
  </div>

</body>

<script>
  // Los valores predeterminados
  const RAZONSOCIAL = "Razón social predeterminada";
  const RUC = "123456789";
  const DIRECCION = "Mi dirección predeterminada";
  const TELEFONO = "987654321";
  const IGV = 18;

  // Las acciones
  const MODIFICAR = 1;
  const ELIMINAR = 2;

  // Los valores seleccionados
  // Arreglos, textos, etc
  let idSeleccionado = -1;
  let accionActual = -1;
  let igvSeleccionado = IGV;
  let productos = [];

  // Cargo los valores predeterminados
  $('#txtRazonSocial').val(RAZONSOCIAL)
  $('#txtRuc').val(RUC);
  $('#txtDireccion').val(DIRECCION);
  $('#txtTelefono').val(TELEFONO);
  $('#txtConsiderarIGV').val(IGV);

  // Cargo el deslizador de página
  $("#contenedor").page();



  // Manejo de botones y cambios

  function cargarDatosCampos(id) {

    let producto = null;

    for (var i = 0; i < productos.length; i++) {
      if (productos[i].id == id) {
        producto = productos[i];
      }
    }
    // Muestra los campos en el formulario para poder editarlos
    if (producto) {
      $("#txtDescripcion").val(producto.descripcion);
      $("#cboMarca").val(producto.marca);
      $("#cboUnidad").val(producto.unidad);
      $("#txtCantidad").val(producto.cantidad);
      $("#txtPrecio").val(producto.precio);
      $("#txtPrecioConIGV").val(producto.precioConIGV);
      $("#txtIGVCalculado").val(producto.igvCalculado);
      $("#txtPrecioSinIGV").val(producto.precioSinIGV);

      // Y enfoco el txtDescripcion
      $("#txtDescripcion").focus();

    }

  }

  function limpiarCampos() {
    $("#txtDescripcion").val("");
    $("#cboMarca").prop('selectedIndex', 0);
    $("#cboUnidad").prop('selectedIndex', 0);
    $("#txtCantidad").val("");
    $("#txtPrecio").val("");
    $("#txtPrecioSinIGV").val("");
    $("#txtIGVCalculado").val("");
    $("#txtPrecioConIGV").val("");

  }

  function actualizarTabla() {

    // Vacío la tabla
    $("#tabla").empty();

    // Reescribo el encabezado
    $("#tabla").append(`
    <div class="fila-tabla encabezado-tabla blue">
                          <div class="celda-tabla">
                            Item
                          </div>
                          <div class="celda-tabla">
                            Descripción
                          </div>
                          <div class="celda-tabla">
                            Marca/Procedencia
                          </div>
                          <div class="celda-tabla">
                            Unidad
                          </div>
                          <div class="celda-tabla">
                            Cantidad
                          </div>
                          <div class="celda-tabla">
                            Precio unidad
                          </div>
                          <div class="celda-tabla">
                            Total con IGV
                          </div>
                          <div class="celda-tabla">
                            IGV calculado
                          </div>
                          <div class="celda-tabla">
                            Total sin IGV
                          </div>
                          <div class="celda-tabla">                            
                          </div>
                          <div class="celda-tabla">                            
                          </div>
                        </div>
    `)

    for (var i = 0; i < productos.length; i++) {

      let producto = productos[i];

      $("#tabla").append(`<div class="fila-tabla">
                          <div class="celda-tabla">
                            ${producto.id}
                          </div>
                          <div class="celda-tabla">
                            ${producto.descripcion}
                          </div>
                          <div class="celda-tabla">
                            ${producto.marca}
                          </div>
                          <div class="celda-tabla">
                            ${producto.unidad}
                          </div>
                          <div class="celda-tabla">
                            ${producto.cantidad}
                          </div>
                          <div class="celda-tabla">
                            ${producto.precio}
                          </div>
                          <div class="celda-tabla">
                            ${producto.precioConIGV}
                          </div>
                          <div class="celda-tabla">
                            ${producto.igvCalculado}
                          </div>
                          <div class="celda-tabla">
                            ${producto.precioSinIGV}
                          </div>
                          <div class="celda-tabla editarRegistro" style="cursor:pointer;" data-id=${producto.id}>
                            <i class="fa fa-edit"></i> Editar
                          </div>
                          <div class="celda-tabla borrarRegistro" style="cursor:pointer;" data-id=${producto.id}>
                            <i class="fa fa-trash"></i> Borrar
                          </div>
                        </div>
`);

    }

    // Finalmente, calculo el total de todo
    calcularTodoTotal();

  }

  function agregarProducto(producto) {
    productos.push(producto);
    actualizarTabla();
    limpiarCampos();
    $("#txtDescripcion").focus();
  }

  function modificarProducto(producto) {
    for (var i = 0; i < productos.length; i++) {
      if (productos[i].id == producto.id) {
        productos[i] = producto;
      }
    }
    actualizarTabla();

  }

  function eliminarProducto(id) {

    for (var i = 0; i < productos.length; i++) {
      if (productos[i].id == id) {
        productos.splice(i, 1);
      }
    }

    actualizarTabla();

  }

  function calcularTodoTotal() {
    let acumulado = 0;

    // Recorro el arreglo y sumo los totales
    for (var i = 0; i < productos.length; i++) {
      acumulado += parseFloat(productos[i].precioConIGV);
    }
    $("#txtTotalTodo").val(acumulado.toFixed(2));

  }

  function calcularPrecioConIGVSinIGV(cantidad, precio) {

    let precioConIGV = parseFloat(cantidad * precio).toFixed(2);
    let precioSinIGV = parseFloat((precioConIGV * 100) / (100 + igvSeleccionado)).toFixed(2);
    $("#txtPrecioConIGV").val(precioConIGV);
    $("#txtPrecioSinIGV").val(precioSinIGV);
    $("#txtIGVCalculado").val(parseFloat(precioConIGV - precioSinIGV).toFixed(2));

  }

  // Hago los cálculos apenas cambie un campo
  $("#txtCantidad").on('input', function () {
    let cantidad = $("#txtCantidad").val();
    let precio = $("#txtPrecio").val();
    if (!isNaN(cantidad) && !isNaN(precio)) {
      calcularPrecioConIGVSinIGV(cantidad, precio);
    }

  });

  $("#txtPrecio").on('input', function () {
    let cantidad = $("#txtCantidad").val();
    let precio = $("#txtPrecio").val();
    if (!isNaN(cantidad) && !isNaN(precio)) {
      calcularPrecioConIGVSinIGV(cantidad, precio);
    }

  });

  // Agrego los campos al hacer click en Agregar
  $("#btnAgregar").click(function (e) {

    let descripcion = $("#txtDescripcion").val();
    let marca = $("#cboMarca").val();
    let unidad = $("#cboUnidad").val();
    let cantidad = parseInt($("#txtCantidad").val(), 10);
    let precio = parseFloat($("#txtPrecio").val());
    let precioSinIGV = parseFloat($("#txtPrecioSinIGV").val());
    let igvCalculado = parseFloat($("#txtIGVCalculado").val());
    let precioConIGV = parseFloat($("#txtPrecioConIGV").val());

    // Primero, verifico si hay campos vacíos 
    if (descripcion != "" && marca != "" && unidad != "" && cantidad != "" && precio != "" && precioSinIGV != "" && precioConIGV != "") {
      // Si todo está bien, que se agregue al arreglo
      $('#mensajeForm2').empty();

      let producto = {};
      producto.id = productos.length + 1;
      producto.descripcion = descripcion;
      producto.marca = marca;
      producto.unidad = unidad;
      producto.cantidad = cantidad;
      producto.precio = precio;
      producto.precioSinIGV = precioSinIGV;
      producto.igvCalculado = igvCalculado;
      producto.precioConIGV = precioConIGV;
      agregarProducto(producto);

    } else {
      $("#contenedor").page().shake();
      $('#mensajeForm2').empty();
      $('#mensajeForm2').append('<div class="alert alert-danger" role="alert">Verifique que todos los campos se han llenado correctamente, incluyendo números</div>');
    }

  })

  // Actualizo el registro seleccionado
  $("#btnActualizar").click(function (e) {

    let descripcion = $("#txtDescripcion").val();
    let marca = $("#cboMarca").val();
    let unidad = $("#cboUnidad").val();
    let cantidad = parseInt($("#txtCantidad").val(), 10);
    let precio = parseFloat($("#txtPrecio").val());
    let precioSinIGV = parseFloat($("#txtPrecioSinIGV").val());
    let igvCalculado = parseFloat($("#txtIGVCalculado").val());
    let precioConIGV = parseFloat($("#txtPrecioConIGV").val());

    // Primero, verifico si hay campos vacíos 
    if (descripcion != "" && marca != "" && unidad != "" && cantidad != "" && precio != "" && precioConIGV != "" && precioSinIGV != "") {
      // Si todo está bien, que se agregue al arreglo
      $('#mensajeForm2').empty();

      let producto = {};
      producto.id = idSeleccionado;
      producto.descripcion = descripcion;
      producto.marca = marca;
      producto.unidad = unidad;
      producto.cantidad = cantidad;
      producto.precio = precio;
      producto.precioConIGV = precioConIGV;
      producto.igvCalculado = igvCalculado;
      producto.precioSinIGV = precioSinIGV;
      modificarProducto(producto);
      limpiarCampos();
      // Deshabilito el btnActualizar, eliminar y habilito el agregar
      $('#btnActualizar').attr("disabled", true);
      $('#btnCancelar').attr("disabled", true);
      $('#btnAgregar').attr("disabled", false);

      accionActual = -1;
      idSeleccionado = -1;

    } else {
      $("#contenedor").page().shake();
      $('#mensajeForm2').empty();
      $('#mensajeForm2').append('<div class="alert alert-danger" role="alert">Verifique que todos los campos se han llenado correctamente, incluyendo números</div>');
    }

  })

  // Cancelo la acción actual y dejo todo como estaba
  $("#btnCancelar").click(function (e) {

    accionActual = -1;
    idSeleccionado = -1;

    limpiarCampos();

    // Habilito el btnActualizar, eliminar y deshabilito el agregar
    $('#btnActualizar').attr("disabled", true);
    $('#btnCancelar').attr("disabled", true);
    $('#btnAgregar').attr("disabled", false);

  })

  // Los botones que se encuentran en cada registro

  $("#tabla").on("click", ".editarRegistro", function (ev) {
    var id = $(ev.target).attr("data-id");
    // Luego, establezco el id y su acción actual
    accionActual = MODIFICAR;
    idSeleccionado = id;

    // Habilito el btnActualizar, eliminar y deshabilito el agregar
    $('#btnActualizar').attr("disabled", false);
    $('#btnCancelar').attr("disabled", false);
    $('#btnAgregar').attr("disabled", true);

    cargarDatosCampos(id);

  });

  $("#tabla").on("click", ".borrarRegistro", function (ev) {
    var id = $(ev.target).attr("data-id");
    $("#cuerpoModalOpcion").empty();
    $("#cuerpoModalOpcion").append(`<p>¿Deseas borrar el item ${id}?</p>`);

    // Luego, establezco el id y su acción actual
    accionActual = ELIMINAR;
    idSeleccionado = id;

    $("#modalOpcion").modal()

  });

  // Manejo de los botones del modal de opciones
  $("#btnSi").on("click", function (ev) {
    if (accionActual == ELIMINAR) {
      eliminarProducto(idSeleccionado);
      accionActual = -1;
      idSeleccionado = -1;
    }
  });

  $("#btnNo").on("click", function (ev) {
    accionActual = -1;
    idSeleccionado = -1;
  });

  // Manejo de deslizador de página

  // La función de validación para mostrar el registro 2
  $("#btnMostrarReg2").click(function (ev) {
    var razonSocial = $('#txtRazonSocial').val();
    var ruc = $('#txtRuc').val()
    var direccion = $('#txtDireccion').val()
    var telefono = $('#txtTelefono').val()
    var igv = $('#txtConsiderarIGV').val()

    if (razonSocial == "" || ruc == "" || direccion == "" || telefono == "" || igv == "") {
      $("#contenedor").page().shake();
      $('#mensajeForm1').empty();
      $('#mensajeForm1').append('<div class="alert alert-danger" role="alert">Hay campos vacíos</div>');
      return;
    }

    // Pasa a la siguiente página
    var page = $(ev.target).attr("data-page-name");

    var trans = $(ev.target).attr("data-page-trans");

    if ($("#contenedor").page().fetch(page) === null) {

      $("#contenedor").page().shake();
    }
    else {
      $("#contenedor").page().transition(page, trans);
    }

    // Borro el mensaje de error si es que lo hay
    $('#mensajeForm1').empty();

    // Guardo el IGV según el elegido
    igvSeleccionado = parseInt($('#txtConsiderarIGV').val(), 10);

    // Muestro el IGV guardado
    $('#txtIGV').val(igvSeleccionado);

    // Cambio el título del encabezado
    $('#encabezado').empty();
    $('#encabezado').append(`
      <div class="col-md-5" style="margin-top: 10px; cursor: pointer;" data-page-name="1"
                      data-page-trans="slide-in-from-left" id="btnMostrarReg1">
      <i class="fa fa-angle-left"></i> Retroceder 
      </div>
      <div class="col-md-7">
      <h4 class="float-left">Generar factura</h4>
      </div>`);

  });

  // Retrocede al registro 1
  $("#encabezado").on("click", "#btnMostrarReg1", function (ev) {
    var page = $(ev.target).attr("data-page-name");

    var trans = $(ev.target).attr("data-page-trans");

    if ($("#contenedor").page().fetch(page) === null) {

      $("#contenedor").page().shake();
    }
    else {
      $("#contenedor").page().transition(page, trans);
    }

    // Cambio el título del encabezado
    $('#encabezado').empty();
    $('#encabezado').append(`<div class="col-md-offset-5 col-md-7">
          <h4 class="float-left">Generar factura</h4></div>`);

  });



  // Script para excel
  $.support.cors = true;
  //var excelIO = new GC.Spread.Excel.IO();

  var workbook = new ExcelJS.Workbook();

  // Esto pone borde, valor y fondo a la celda
  function establecerValorCelda(worksheet, celda, valor, colorFuente, colorFondo, esNegrita, colorBorde) {

    // Si le paso un color de fondo, que lo aplique
    if (colorFondo) {
      worksheet.getCell(celda).fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: colorFondo }
      };
    }
    if (colorBorde) {
      worksheet.getCell(celda).border = {
        top: { style: 'thin', color: { argb: colorBorde } },
        left: { style: 'thin', color: { argb: colorBorde } },
        bottom: { style: 'thin', color: { argb: colorBorde } },
        right: { style: 'thin', color: { argb: colorBorde } }
      };
    }

    if (valor) {
      worksheet.getCell(celda).value = {
        "richText": [
          {
            "font": { "bold": esNegrita, "color": { "argb": colorFuente } },
            "text": valor
          }
        ]
      };
    }


  }

  function establecerFormulaCelda(worksheet, celda, formula, colorFondo, colorBorde) {
    worksheet.getCell(celda).value = { formula: formula };
    
    // Si le paso un color de fondo, que lo aplique
    if (colorFondo) {
      worksheet.getCell(celda).fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: colorFondo }
      };
    }
    if (colorBorde) {
      worksheet.getCell(celda).border = {
        top: { style: 'thin', color: { argb: colorBorde } },
        left: { style: 'thin', color: { argb: colorBorde } },
        bottom: { style: 'thin', color: { argb: colorBorde } },
        right: { style: 'thin', color: { argb: colorBorde } }
      };
    }
  }

  function unirCeldas(worksheet, inicio, fin, valor, colorBorde, colorFuente, colorFondo, esNegrita) {

    if (valor) {
      worksheet.getCell(inicio).value = {
        "richText": [
          {
            "font": { "bold": esNegrita, "color": { "argb": colorFuente } },
            "text": valor
          }
        ]
      };
    }

    if (colorBorde) {
      worksheet.getCell(inicio).border = {
        top: { style: 'thin', color: { argb: colorBorde } },
        left: { style: 'thin', color: { argb: colorBorde } },
        bottom: { style: 'thin', color: { argb: colorBorde } },
        right: { style: 'thin', color: { argb: colorBorde } }
      };
    }
    if (colorFondo) {
      worksheet.getCell(inicio).fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: colorFondo }
      };
    }

    worksheet.getCell(inicio).alignment = { vertical: 'middle', horizontal: 'left' };
    worksheet.mergeCells(inicio + ":" + fin);

  }

  function agregarFinPlantillaGlassgow(worksheet, filInicio, workbook) {
    unirCeldas(worksheet, `A${filInicio + 3}`, `G${filInicio + 3}`)
    unirCeldas(worksheet, `A${filInicio + 4}`, `B${filInicio + 9}`, "CONDICIONES:", true, "ffffff", "0b5961", true,'000000')
    establecerValorCelda(worksheet, `C${filInicio + 4}`, "FORMA DE PAGO:", "ffffff", "0b5961", true,'000000')
    establecerValorCelda(worksheet, `C${filInicio + 5}`, "PRECIO:", "ffffff", "0b5961", true,'000000')
    establecerValorCelda(worksheet, `C${filInicio + 6}`, "IMPUESTOS:", "ffffff", "0b5961", true,'000000')
    establecerValorCelda(worksheet, `C${filInicio + 7}`, "CUENTA BANCARIA- CCI:", "ffffff", "0b5961", true,'000000')
    establecerValorCelda(worksheet, `C${filInicio + 8}`, "ENTREGA:", "ffffff", "0b5961", true,'000000')
    establecerValorCelda(worksheet, `C${filInicio + 9}`, "GARANTÍA", "ffffff", "0b5961", true,'000000')

    establecerValorCelda(worksheet, `D${filInicio + 4}`, "CONTADO COMERCIAL",null,null,false,'000000')
    establecerValorCelda(worksheet, `D${filInicio + 5}`, "SOLES",null,null,false,'000000')
    establecerValorCelda(worksheet, `D${filInicio + 6}`, "INCLUYE IGV",null,null,false,'000000')
    establecerValorCelda(worksheet, `D${filInicio + 7}`, "BCP SOLES...",null,null,false,'000000')
    establecerValorCelda(worksheet, `D${filInicio + 8}`, "5 DÍAS DESPUÉS",null,null,false,'000000')
    establecerValorCelda(worksheet, `D${filInicio + 9}`, "1 AÑO",null,null,false,'000000')

    unirCeldas(worksheet, `E${filInicio + 4}`, `G${filInicio + 9}`, "", "000000")

    /*leerFirmaGlassgow().then(data => {
      var firmaGlassgow = workbook.addImage({
        base64: data,
        extension: 'jpeg',
        base64filename: 'cora.png'
      });
      worksheet.addImage(firmaGlassgow, "A23:C25");
      //`E${filInicio + 4}:G${filInicio + 9}`
    })*/



  }

  // Esto es una promesa
  function leerPlantilla(excelUrl) {

    return new Promise((resolve, reject) => {

      var req = new XMLHttpRequest();
      req.open("GET", excelUrl, true);//
      req.responseType = "arraybuffer";

      req.onload = function (e) {
        if (req.status == 200) {
          var data = req.response;

          workbook.xlsx.load(data).then(function (workbook) {
            resolve(workbook);
          })
        } else {
          reject('El servidor ha respondido con estado ' + req.status);
        }

      }
      req.send();

    })

  }

  function leerFirmaGlassgow() {
    return new Promise((resolve, reject) => {

      var imgUrl = "../plantillas/firmaGlassgow.png";

      var req = new XMLHttpRequest();
      req.open("GET", imgUrl, true);//
      req.responseType = "arraybuffer";

      req.onload = function (e) {
        if (req.status == 200) {
          var blob = new Uint8Array(req.response);
          //encode with base64
          var uri = "data:image/jpeg;base64," + Base64.encode(blob);
          resolve(uri);

        } else {
          reject('El servidor ha respondido con estado ' + req.status);
        }

      }
      req.send();

    })
  }

  function generarExcelGlassgow() {


    // Establece los índices de inicio de las filas y columnas
    let filInicio = 11;
    let colInicio = 1;

    // Uso promesas para esperar a que termine de leer la plantila
    leerPlantilla("../plantillas/formatoGlassgowSimple.xlsx")
      .then((workbook) => {

        const ws = workbook.getWorksheet('1');

        // Por cada uno de los productos, lleno los registros del Excel
        for (var i = 0; i < productos.length; i++) {

          let producto = productos[i];
          establecerValorCelda(ws, `A${filInicio}`, producto.id,null,null,false,'000000');
          establecerValorCelda(ws, `B${filInicio}`, producto.cantidad,null,null,false,'000000');
          establecerValorCelda(ws, `C${filInicio}`, producto.unidad,null,null,false,'000000');
          establecerValorCelda(ws, `D${filInicio}`, producto.descripcion,null,null,false,'000000');
          establecerValorCelda(ws, `E${filInicio}`, producto.marca,null,null,false,'000000');
          establecerValorCelda(ws, `F${filInicio}`, producto.precio,null,null,false,'000000');
          //establecerValorCelda(ws, `G${filInicio}`, producto.precioConIGV);

          // Establezco la fórmula para los subtotales de cada registro (=precioConIGV)
          establecerFormulaCelda(ws, `G${filInicio}`, `=TRUNC((B${(filInicio)}*F${(filInicio)}),2)`, null, '000000')

          filInicio++;
        }

        // Para los totales de todos los registros
        // Primero, el total (Suma simple)
        establecerValorCelda(ws, `F${filInicio + 2}`, "TOTAL", "ffffff", "0b5961", true,'000000');
        establecerFormulaCelda(ws, `G${filInicio + 2}`, `=TRUNC(SUM(G11:G${(filInicio - 1)}),2)`, null, '000000')

        // Luego, el subtotal (precioConIGV*100)/(100+igvSeleccionado)
        establecerValorCelda(ws, `F${filInicio}`, "SUBTOTAL", "ffffff", "0b5961", true,'000000');
        establecerFormulaCelda(ws, `G${filInicio}`, `=TRUNC(((G${filInicio + 2}*100)/(100+${igvSeleccionado})),2)`, null, '000000')

        // Luego, el IGV (total-subtotal)
        establecerValorCelda(ws, `F${filInicio + 1}`, "IGV", "ffffff", "0b5961", true),'000000';
        establecerFormulaCelda(ws, `G${filInicio + 1}`, `=TRUNC((G${filInicio + 2}-G${filInicio}),2)`, null, '000000')



        // Luego, establezco la parte final para la plantilla de Glassgow
        agregarFinPlantillaGlassgow(ws, filInicio, workbook);

        guardarExcel(workbook);
      })
      .catch((error) => {
        alert(error);
      })

  }

  function generarExcelLH() {

    // Establece los índices de inicio de las filas y columnas
    let filInicio = 9;
    let colInicio = 2;

    // Uso promesas para esperar a que termine de leer la plantila
    leerPlantilla("../plantillas/formatoLHSimple.xlsx")
      .then((workbook) => {

        const ws = workbook.getWorksheet('1');

        // Por cada uno de los productos, lleno los registros del Excel
        for (var i = 0; i < productos.length; i++) {

          let producto = productos[i];

          // Este formato requiere unir las celdas B y C de descripción
          unirCeldas(ws, `B${filInicio}`, `C${filInicio}`, producto.descripcion);
          establecerValorCelda(ws, `D${filInicio}`, producto.marca)
          establecerValorCelda(ws, `E${filInicio}`, producto.cantidad);
          establecerValorCelda(ws, `F${filInicio}`, producto.precio);

          // Establezco la fórmula para los subtotales de cada registro (=precioConIGV)
          establecerFormulaCelda(ws, `G${filInicio}`, `=TRUNC((E${(filInicio)}*F${(filInicio)}),2)`);

          filInicio++;
        }

        // Para los totales de todos los registros
        // Primero, el total (Suma simple)
        establecerValorCelda(ws, `F${filInicio + 3}`, "TOTAL:", "000000", "ffffff", true, '000000');
        establecerFormulaCelda(ws, `G${filInicio + 3}`, `=TRUNC(SUM(G9:G${(filInicio - 1)}),2)`);

        // Luego el subtotal (precioConIGV*100)/(100+igvSeleccionado)
        establecerValorCelda(ws, `F${filInicio + 1}`, "SUB TOTAL:", "000000", "ffffff", true, '000000');
        establecerFormulaCelda(ws, `G${filInicio + 1}`, `=TRUNC(((G${filInicio + 3}*100)/(100+${igvSeleccionado})),2)`);

        // Luego, el IGV (total-subtotal)
        establecerValorCelda(ws, `F${filInicio + 2}`, "I.G.V.:", "000000", "ffffff", true, '000000');
        establecerFormulaCelda(ws, `G${filInicio + 2}`, `=TRUNC((G${filInicio + 3}-G${filInicio+1}),2)`);
        
        // Luego, establezco la parte final para la plantilla de Glassgow
        //agregarFinPlantillaGlassgow(ws, filInicio, workbook);
                
        guardarExcel(workbook);
      })
      .catch((error) => {
        alert(error);
      })

  }

  function generarExcelNA() {

// Establece los índices de inicio de las filas y columnas
let filInicio = 18;
let colInicio = 1;

// Uso promesas para esperar a que termine de leer la plantila
leerPlantilla("../plantillas/formatoNASimple.xlsx")
  .then((workbook) => {

    const ws = workbook.getWorksheet('1');

    // Por cada uno de los productos, lleno los registros del Excel
    for (var i = 0; i < productos.length; i++) {

      let producto = productos[i];
      // Este formato requiere unir las celdas A y B de cantidad
      unirCeldas(ws, `A${filInicio}`, `B${filInicio}`, producto.cantidad, '000000');
      establecerValorCelda(ws, `C${filInicio}`, producto.unidad, null,null,null,'000000');

      // Este formato requiere unir las celdas D a G de descripción
      unirCeldas(ws, `D${filInicio}`, `G${filInicio}`, producto.descripcion, '000000');
      establecerValorCelda(ws, `H${filInicio}`, producto.precio, null,null,null,'000000');

      // Establezco la fórmula para los subtotales de cada registro (=precioConIGV)
      establecerFormulaCelda(ws, `I${filInicio}`, `=TRUNC((A${(filInicio)}*H${(filInicio)}),2)`, null, '000000');

      filInicio++;
    }

    // Para los totales de todos los registros
    // Primero, el total (Suma simple)
    establecerValorCelda(ws, `H${filInicio}`, "Total", "000000", "ffffff", false, '000000');
    establecerFormulaCelda(ws, `I${filInicio}`, `=TRUNC(SUM(I18:I${(filInicio - 1)}),2)`,null,'000000');
       
    unirCeldas(ws, `A${filInicio+5}`,`I${filInicio+5}`, "LOS PRECIOS INCLUYEN EL IGV Y ESTAN EXPRESADOS EN SOLES", null, null, false,null);
    unirCeldas(ws, `A${filInicio+6}`,`I${filInicio+6}`, "ENTREGA 5 DIAS UTILES", null, null, false, null);
    unirCeldas(ws, `A${filInicio+7}`,`I${filInicio+7}`, "VENCIMIENTO DE 1 AÑO", null, null, false, null);
              
    guardarExcel(workbook);
  })
  .catch((error) => {
    alert(error);
  })

}

  function guardarExcel(workbook) {
    /*const options = {
          base64: true,
        };
        */
    var nombreArchivo = "exportado";
    if (nombreArchivo.substr(-5, 5) !== '.xlsx') {
      nombreArchivo += '.xlsx';
    }
    workbook.xlsx
      .writeBuffer(/*options*/)
      .then(buffer => {
        saveAs(new Blob([buffer], { type: "" }), nombreArchivo)
      })
      .catch(error => {
        alert(JSON.stringify(error))
        throw error;
      });
  }

  $('#btnExportarGlassgow').click(function () {
    generarExcelGlassgow();
  })

  $('#btnExportarLH').click(function () {
    generarExcelLH();
  })

  $('#btnExportarNA').click(function () {
    generarExcelNA();
  })

  // Clase utilitaria
  var Base64 = {
    _keyStr: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",

    // public method for encoding
    encode: function (input) {
      var output = "";
      var chr1, chr2, chr3, enc1, enc2, enc3, enc4;
      var i = 0;
      //input = Base64._utf8_encode(input); //comment out to encode binary file(like image)

      while (i < input.length) {

        chr1 = input[i++];
        chr2 = input[i++];
        chr3 = input[i++];

        enc1 = chr1 >> 2;
        enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
        enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
        enc4 = chr3 & 63;

        if (isNaN(chr2)) {
          enc3 = enc4 = 64;
        } else if (isNaN(chr3)) {
          enc4 = 64;
        }
        output = output +
          Base64._keyStr.charAt(enc1) + Base64._keyStr.charAt(enc2) +
          Base64._keyStr.charAt(enc3) + Base64._keyStr.charAt(enc4);
      }
      return output;
    }
  }

  /*https://aymkdn.github.io/ExcelPlus/*
  /*https://www.grapecity.com/blogs/how-to-importexport-excel-files-using-javascript-and-spread-sheets*/
</script>